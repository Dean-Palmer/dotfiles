const FILLABLE_INPUT_FIELD_TYPES=["text","email","number","password","url","tel"],OPFIELD_ID_ATTRIBUTE="data-op-id",OPFIELD_FILLED_ATTRIBUTE="data-com-onepassword-filled",OPFORM_ID_ATTRIBUTE="data-op-form-id",MIN_OPFIELD_WIDTH=90,MIN_OPFIELD_HEIGHT=5;function initCollection(e){return t=>t.forEach(e)}function getPasswordFields(e){return Array.from(e.getElementsByTagName("input")).filter(e=>"password"===e.type)}function getFillableInputFields(e){return Array.from(e.getElementsByTagName("input")).filter(e=>FILLABLE_INPUT_FIELD_TYPES.indexOf(e.type)>=0)}function elementIsVisible(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)}function elementIsUsable(e){return e.offsetWidth>=MIN_OPFIELD_WIDTH&&e.offsetHeight>=MIN_OPFIELD_HEIGHT&&!e.readOnly&&!e.disabled}function hasOPForm(e){const t=e.form;return!!t&&t.hasAttribute(OPFORM_ID_ATTRIBUTE)}function getFirstInputField(e){const t=getFillableInputFields(e).filter(e=>elementIsVisible(e)&&elementIsUsable(e));return 0===t.length?null:t[0]}function initForm(e,t){0!==getPasswordFields(e).length&&e.setAttribute(OPFORM_ID_ATTRIBUTE,""+t)}function initField(e,t){const n="password"===e.type;(hasOPForm(e)||n)&&e.setAttribute(OPFIELD_ID_ATTRIBUTE,""+t)}function collectInlineForms(){const e=initCollection(initForm),t=initCollection(initField);e(Array.from(document.forms).filter(e=>!isGlobalForm(e))),t(getFillableInputFields(document.body))}function getBrainOPID(e){let t=document.querySelectorAll("input, select, button");for(let[n,i]of t.entries())if(e===i)return n;return-1}function getFieldWithBrainOPID(e){let t=document.querySelectorAll("input, select, button");for(let[n,i]of t.entries())if(e===n)return i;return null}function isGlobalForm(e){return e.parentNode&&e.parentNode===document.body}function isFillableField(e){return e instanceof HTMLInputElement&&FILLABLE_INPUT_FIELD_TYPES.includes(e.type.toLowerCase())&&elementIsUsable(e)}const FORM_KEYS=["ArrowDown","ArrowUp","Escape","Enter","Tab"],BUTTON_WIDTH_MEDIUM=16,BUTTON_SIZE_LARGE=24,BUTTON_SIZE_SMALL=12;class OPFormManager{constructor(e){this.handleFieldChanged=(e=>{isFillableField(e)&&this.props.onFieldChanged(e)}),this.handleLockStateChanged=(e=>{this.state.buttonState=e?"locked":"active";const t=document.activeElement;t.blur(),t.focus(),sendMessageToInline({name:"close-inline-menu"})}),this.handleOPButtonClick=(e=>{e.stopImmediatePropagation(),e.preventDefault();const t=getFieldForButton(e.target);t&&this.props.onOPButtonClicked(t)}),this.handleFocusIn=(e=>{if(this.state.disabled)return;const t=e.target;t instanceof HTMLInputElement&&menu.activeInput!==t&&(this.handleFieldChanged(t),getButtonForField(t)||this.render())}),this.handleKeyDown=(e=>{if(!e.isTrusted)return;if(FORM_KEYS.indexOf(e.key)<0)return;e.target.hasAttribute(OPFIELD_ID_ATTRIBUTE)&&this.props.onKeyDown(e)}),this.handleBodyKeyDownEvent=(e=>{if(!e.isTrusted)return;if(220!==e.keyCode||!e.metaKey)return;const t=e.target;"INPUT"===t.tagName&&(t.hasAttribute(OPFIELD_ID_ATTRIBUTE)?this.props.onKeyDown(e):(this.promote(t,!0),e.preventDefault()))}),this.handleInput=(e=>{const t=e.target;t.hasAttribute(OPFIELD_ID_ATTRIBUTE)&&(t.form&&this.handleFormChanged(t.form),t.hasAttribute(OPFIELD_FILLED_ATTRIBUTE)&&t.removeAttribute(OPFIELD_FILLED_ATTRIBUTE),this.props.onInput(t))}),this.handleFormChanged=(e=>{const t=e.getAttribute(OPFORM_ID_ATTRIBUTE);if(!t)return;const n=this.state.formData[t];if(!n)return;const i=hasFormChanged(n,new FormData(e));this.props.onFormEdited(e,i)}),this.createOPButtonElement=(e=>{const t=getOPButtonOffsetByFieldPadding(e),n=document.createElement("com-1password-op-button");n.id="com-1password-op-button",n.addEventListener("mousedown",this.handleOPButtonClick,!0),n.setAttribute("data-op-target",""+e.getAttribute(OPFIELD_ID_ATTRIBUTE)),n.setAttribute("data-state",this.state.buttonState),e.insertAdjacentElement("beforebegin",n);const i=e.getBoundingClientRect();let o=n.getBoundingClientRect();const a=e.offsetHeight,s=e.offsetWidth,l=calculateButtonSizeForField(e),r=l===BUTTON_SIZE_SMALL,d=l===BUTTON_SIZE_LARGE;r&&!n.classList.contains("op-small")?(n.classList.add("op-small"),o=n.getBoundingClientRect()):d&&!n.classList.contains("op-large")&&(n.classList.add("op-large"),o=n.getBoundingClientRect());const u=i.top-o.top,m=i.left-o.left;let c="color";"mono-light"!==this.props.traits.iconColor&&"mono-dark"!==this.props.traits.iconColor||(c="mono");const h="locked"===this.state.buttonState?"locked":"unlocked",f=r?"12":"16";n.setAttribute("style",`\n        margin-left: ${m+s-t-1.5*o.width}px !important;\n        margin-top: ${u+(a-o.height)/2}px !important;\n        background-image: url($BASE_URL/images/icons/app_icon-light_bg-${c}-${h}-${f}.svg) !important;\n        `)}),this.render=(()=>{if(this.state.disabled)return;document.querySelectorAll("com-1password-op-button").forEach(removeElement);const e=document.activeElement;isOPField(e)&&this.createOPButtonElement(e)}),this.props=e;const t=keyedFormData(document.forms);this.state={opidCount:0,formCount:0,disabled:!1,buttonState:this.props.initialButtonState,formData:t,allInputFields:[],lastInputFieldCount:0,lastFillableFieldCount:0,designations:[]};const n=document.activeElement;isFillableField(n)&&setTimeout(()=>{this.handleFieldChanged(n)},1),document.body.addEventListener("focusin",this.handleFocusIn),document.body.addEventListener("keydown",this.handleBodyKeyDownEvent,!0),window.addEventListener("resize",debounce(()=>{this.render()},100,this))}get button(){const e=document.activeElement.getAttribute(OPFIELD_ID_ATTRIBUTE);return e?document.querySelector(`com-1password-op-button[data-op-target='${e}']`):null}click(){const e=this.button;e&&e.dispatchEvent(new MouseEvent("mousedown"))}promote(e,t){if(isFillableField(e))if(e.hasAttribute(OPFIELD_ID_ATTRIBUTE))menu.isLoaded()||t&&this.click();else{if(e.addEventListener("keydown",this.handleKeyDown,!0),e.addEventListener("input",this.handleInput,!0),e.setAttribute(OPFIELD_ID_ATTRIBUTE,""+this.state.opidCount),this.state.opidCount++,e.form){const t=""+this.state.formCount;e.form.setAttribute(OPFORM_ID_ATTRIBUTE,t),this.state.formData[t]=new FormData(e.form),this.state.formCount++}this.render(),t&&this.click()}}updateFormData(){this.state.formData=keyedFormData(document.forms)}}function isOPField(e){return isFillableField(e)&&e.hasAttribute(OPFIELD_ID_ATTRIBUTE)}function getButtonForField(e){const t=e.getAttribute(OPFIELD_ID_ATTRIBUTE),n=document.getElementsByTagName("com-1password-op-button");if(0===n.length)return null;for(let e=0;e<n.length;e++){const i=n[e],o=i.getAttribute("data-op-target");if(o&&o===t)return i}return null}function hasButton(e){return null!==getButtonForField(e)}function getFieldForButton(e){const t=e.getAttribute("data-op-target");return document.querySelector(`input[${OPFIELD_ID_ATTRIBUTE}='${t}'`)}function calculateButtonSizeForField(e){let t=BUTTON_WIDTH_MEDIUM;return e.offsetHeight>=38&&(t=BUTTON_SIZE_LARGE),e.offsetHeight<BUTTON_WIDTH_MEDIUM+4&&(t=BUTTON_SIZE_SMALL),t}function removeElement(e){const t=e.parentNode;t&&t.removeChild(e)}function getOPButtonOffsetByFieldPadding(e){const t=window.getComputedStyle(e),n=parseFloat(t.paddingLeft||"0");var i=parseFloat(t.paddingRight||"0")-n;if(i<=Number.EPSILON)return 0;let o=parseFloat(t.lineHeight||"normal");return isNaN(o)&&(o=1.2*parseFloat(t.fontSize||"0")),i>o?i+4:0}function keyedFormData(e){return Array.from(e).reduce((e,t)=>{const n=t.getAttribute(OPFORM_ID_ATTRIBUTE);return n?Object.assign(e,{[n]:new FormData(t)}):e},{})}function hasFormChanged(e,t){const n=e.entries();let i;for(;(i=n.next())&&!i.done;){const[e,n]=i.value;if(n!==t.get(e))return!0}return!1}function debounce(e,t,n,i=!1){var o,a,s,l,r,d=function(){var n=Date.now()-l;n<t&&n>=0?o=setTimeout(d,t-n):(o=null,i||(r=e.apply(s,a),o||(s=a=null)))};return function(){s=n,a=arguments,l=Date.now();var u=i&&!o;return o||(o=setTimeout(d,t)),u&&(r=e.apply(s,a),s=a=null),r}}const MENU_WIDTH=250,IFRAME_ID="op-popup",ZINDEX_MAX=2147483647;class InlineMenuFrame{constructor(){this.alwaysShow=!1,this.focused=!1,this.activeInput=null,this.frameCreationInProgress=!1,this.onLoad=(e=>{addMessageListener(function t(n){"inline-ready"===n.name&&(e(),removeMessageListener(t))})}),this.isLoaded=(()=>null!==this.element),this.isVisible=(()=>!!this.element&&(this.element.classList.contains("ready")&&this.element.offsetHeight>0)),this.isFocused=(()=>this.focused),this.filterBy=(e=>{sendValue(e)}),this.show=(()=>{this.element&&(this.isVisible()||this.element.classList.add("ready"))}),this.hide=(()=>{this.element&&this.element.classList.remove("ready")}),this.focus=(()=>{let e=document.activeElement;if(!e||e.id===IFRAME_ID)return;let t=this.element;t&&(e.blur(),setTimeout(()=>{t.focus(),t.contentWindow&&t.contentWindow.focus(),t.contentDocument&&t.contentDocument.focus()},1))}),this.focusField=(()=>{this.activeInput&&(document.activeElement.blur(),setTimeout(()=>{this.activeInput.focus()},1))}),this.resize=(e=>{if(this.element)if(e>0){this.show();const t=Math.min(36+53*e-1,220);this.element.style.height=t+"px"}else this.hide()}),this.down=(()=>sendKey("ArrowDown")),this.up=(()=>sendKey("ArrowUp")),this.enter=(()=>sendKey("Enter")),this.load=((e,t,n="")=>{this.activeInput=e,chrome.runtime.sendMessage({name:"init-inline-menu",data:{location:window.location.href,path:t,className:n,position:calculateIframePosition(e)}})}),this.unload=(()=>{this.element&&(this.frameCreationInProgress=!1,this.activeInput=null,this.focused=!1,this.alwaysShow=!1,this.destroyIFrame(this.element))}),this.calcFrameStyleWithOffset=(e=>{if(!this.activeInput)return{top:0,left:0};const{offsetX:t,offsetY:n}=calculateIframePosition(this.activeInput);return{top:n+e.top,left:t+e.left}}),this.listen()}listen(){addMessageListener(e=>{switch(e.name){case"inline-ready":break;case"inline-items-loaded":if(!this.element)return;this.resize(e.data.numItems);break;case"inline-focus-changed":let t=e.data.index;this.focused=t.section>=0;break;case"inline-options-expanded":if(!this.element)return;this.alwaysShow&&this.show(),this.element.style.height="229px";break;case"focus-inline-field":this.focusField();break;case"inline-resize":if(!this.activeInput)return void sendMessageToInline({name:"remove-resize-event",frameId:0});sendMessageToInline({name:"inline-position",frameId:0,data:{position:this.calcFrameStyleWithOffset(e.data.offset),depth:e.data.offset.depth}})}})}get element(){return document.getElementById(IFRAME_ID)}value(){return this.activeInput?this.activeInput.value:""}destroyIFrame(e){e&&document.body.removeChild(e)}}function calculateIframePosition(e){const t=e.getBoundingClientRect(),n={x:0,y:0},i=getRelativeBodyMargin();i&&(n.y=i.marginTop,n.x=i.marginLeft);const o=t.left+window.scrollX-n.x,a=t.top+e.offsetHeight+window.scrollY-n.y;return{offsetX:Math.max(o,0),offsetY:a,x:o,y:a}}const getRelativeBodyMargin=(()=>{let e=null;return()=>{if(e&&e.isRelative)return e;if(e&&!e.isRelative)return null;const t=window.getComputedStyle(document.body);return(e={marginTop:parseFloat(t.marginTop||"0"),marginLeft:parseFloat(t.marginLeft||"0"),isRelative:"relative"==t.position}).isRelative?e:null}})();function addMessageListener(e){chrome.runtime.onMessage.addListener(e)}function removeMessageListener(e){chrome.runtime.onMessage.removeListener(e)}function sendKey(e){return new Promise(t=>{sendMessageToInline({name:"key-pressed",data:{key:e}},e=>{t(e)})})}function sendValue(e){sendMessageToInline({name:"value-changed",data:{value:e}})}class Knight{constructor(){this.activeInput=null,this.state={locked:!0,autoshow:!0,updateMode:!1,edited:!1,tabId:0,frameId:0,locale:"en",iconColor:"color-light",location:"",resizeFrameId:0}}setState(e){this.state=Object.assign({},this.state,e)}getActiveFillMode(e){return"active"}getPassiveFillMode(e){return"password"===e.type?"passive":""!==e.value||this.isEdited(e)?"none":"passive"}loadMenu(e,t){this.activeInput=e;const n=getBrainOPID(e),i=knight.isEdited(e);let o=`/${this.state.locale}/fill/login/${t}/${this.state.tabId}/${this.state.frameId}/${n}/${getInputType(e)}`;i&&(o+="/edited"),menu.load(e,o),"active"===t&&(menu.alwaysShow=!0),menu.onLoad(()=>{const e={edited:i};"active"!==t&&(e.filter=menu.value()),sendMessageToInline({name:"form-state-changed",data:e})})}isEdited(e){return e.form?this.state.edited:""!==e.value}}const menu=new InlineMenuFrame;let formManager;const knight=new Knight;function setAllState(e){sendMessageToInline({name:"knight-state",data:{state:e}})}function handleFieldChanged(e){const t=knight.state.autoshow;menu.unload();const n=knight.getPassiveFillMode(e),i=formManager.state.designations.find(t=>t.element===e);i&&""===i.fieldDesignation||chrome.runtime.sendMessage({name:"analyze-field",data:{opid:getBrainOPID(e),value:e.value,fieldDesignation:i&&i.fieldDesignation,formDesignation:i&&i.formDesignation}},o=>{if(o.shouldDecorate&&formManager.promote(e,!1),o.shouldLoadMenu){if("none"===n||knight.state.locked)return;t&&knight.loadMenu(e,knight.getPassiveFillMode(e))}i||formManager.state.designations.push({element:e,fieldDesignation:o.fieldDesignation,formDesignation:o.formDesignation})})}function handleOPButtonClicked(e){knight.activeInput=e,sendMessageToInline({name:"op-button-clicked",frameId:0,data:{frameId:knight.state.frameId}})}function handleKeyDown(e){switch(e.key){case"ArrowDown":case"ArrowUp":e.stopPropagation(),e.preventDefault()}handleCommandBackslash(e),sendMessageToInline({name:"inline-key-pressed",frameId:0,data:{key:e.key,frameId:knight.state.frameId}})}function handleCommandBackslash(e){e.metaKey&&220===e.keyCode&&!e.shiftKey&&(e.stopPropagation(),e.preventDefault(),sendMessageToInline({name:"toggle-inline-menu",frameId:knight.state.frameId}))}function handleInput(e){sendMessageToInline({name:"form-state-changed",data:{edited:knight.isEdited(e),filter:e.value}})}function handleFormEditChange(e,t){if(setAllState({edited:t}),knight.state.autoshow&&document.activeElement instanceof HTMLInputElement&&document.activeElement.hasAttribute(OPFIELD_ID_ATTRIBUTE)){const e=knight.getPassiveFillMode(document.activeElement);if("none"===e||menu.isLoaded()||knight.state.locked)return;knight.loadMenu(document.activeElement,e)}}function showSaveLoginPrompt(e){setAllState({autoshow:!1});let t=document.createElement("iframe");t.id="op-save-login",t.src=`$BASE_URL/inline/inline.html#/${knight.state.locale}/savelogin/${knight.state.tabId}/${e}`,document.body.appendChild(t),document.body.setAttribute("op-scroll-lock","1"),t.focus()}function showInlineMenu(e,t="",n,i,o,a){menu.frameCreationInProgress=!0,setAllState({location:i,resizeFrameId:n});const s=document.createElement("iframe");s.id="op-popup",s.src=`$BASE_URL/inline/inline.html#${e}`,s.className=t,s.onload=(()=>{sendMessageToInline({name:"focus-inline-field",frameId:n}),setInlinePosition(o,a),window.addEventListener("resize",handleResize),menu.frameCreationInProgress=!1}),document.body.appendChild(s)}const handleResize=debounce(()=>{chrome.runtime.sendMessage({name:"inline-resize",data:{location:knight.state.location,frameId:knight.state.resizeFrameId}})},100);function hideSaveLoginPrompt(){setAllState({autoshow:!0});const e=document.getElementById("op-save-login");e&&(document.body.removeChild(e),document.body.removeAttribute("op-scroll-lock"))}function getInputType(e){return"password"==e.type.toLowerCase()?"password":"username"}function handleBodyClick(e){const t=e.target;t!==knight.activeInput&&(t.hasAttribute(OPFIELD_ID_ATTRIBUTE)||sendMessageToInline({name:"close-inline-menu"}))}function handleFocusIn(e){const t=e.target;t!==knight.activeInput&&t.id!==IFRAME_ID&&sendMessageToInline({name:"close-inline-menu"})}function setInlinePosition(e,t){menu.element.style.position="absolute",menu.element.style.zIndex=`${ZINDEX_MAX}`;const n=document.documentElement,i=(window.pageYOffset||n.scrollTop)-(n.clientTop||0),o=(window.pageXOffset||n.scrollLeft)-(n.clientLeft||0),a=e.top+(t>0?i:0),s=e.left+(t>0?o:0);menu.element.style.top=`${a}px`,menu.element.style.left=`${s}px`}function runtimeMessageHander(e,t,n){if("configure-knight"===e.name){let{tabId:t,frameId:n,locale:i,locked:o,activeByDefault:a,traits:s,recipe:l}=e.data,r=!("Pending"===s.fillState||!a);knight.setState({tabId:t,frameId:n,locale:i,locked:o,autoshow:r}),document.body.addEventListener("mousedown",handleBodyClick),document.body.addEventListener("focusin",handleFocusIn);let d=o?"locked":"active";window._opformManager||((formManager=new OPFormManager({traits:s,recipe:l,initialButtonState:d,onFieldChanged:handleFieldChanged,onFormEdited:handleFormEditChange,onInput:handleInput,onOPButtonClicked:handleOPButtonClicked,onKeyDown:handleKeyDown})).render(),window._opformManager=!0)}else if("lock-state-changed"===e.name)menu.unload(),setAllState({locked:e.data.locked}),formManager.handleLockStateChanged(e.data.locked);else if("inline-lose-focus"===e.name)menu.focusField();else if("focus-field"===e.name)menu.activeInput&&menu.activeInput.focus();else if("inline-close-menu"===e.name)menu.activeInput&&menu.activeInput.focus(),formManager.click();else if("inline-tab-key-pressed"===e.name)menu.activeInput&&menu.activeInput.focus(),e.data.forward;else if("item-fill-start"===e.name)knight.setState({autoshow:!1}),menu.unload(),n(!0);else if("item-fill-end"===e.name)if(knight.setState({autoshow:!0,edited:!1}),e.data.postFill&&"FocusNextField"===e.data.postFill){const e=document.activeElement;isFillableField(e)&&handleFieldChanged(e)}else isFillableField(document.activeElement)&&formManager.promote(document.activeElement);else if("show-save-login-prompt"===e.name){menu.unload(),showSaveLoginPrompt(e.data.sessionId)}else if("close-save-login-prompt"===e.name)hideSaveLoginPrompt(),e.data.saved&&(setAllState({updateMode:!0,edited:!1}),formManager.updateFormData());else if("load-inline"===e.name){const e=getFillableInputFields(document.body);if(0===e.length)return;const t=e[0];formManager.promote(t)}else if("show-inline"===e.name)document.activeElement instanceof HTMLInputElement&&formManager.promote(document.activeElement,!0);else if("show-inline-menu"===e.name){if(menu.isLoaded()&&menu.isVisible())return;menu.unload();const t=e.data.depth,n=e.data.offset;showInlineMenu(e.data.path,e.data.className,e.data.frameId,e.data.location,n,t)}else if("show-inline-style"===e.name)menu.show();else if("close-inline-menu"===e.name)menu.activeInput=null,window===window.top&&menu.unload(),formManager.render();else if("inline-key-pressed"===e.name){const t=e.data.frameId;switch(e.data.key){case"ArrowDown":menu.isVisible()?(menu.down(),!knight.state.locked&&menu.focus()):sendMessageToInline({name:"toggle-inline-menu",frameId:t});break;case"ArrowUp":if(!menu.isLoaded())return;if(knight.state.locked)return void sendMessageToInline({name:"toggle-inline-menu",frameId:t});menu.isFocused()?menu.up():sendMessageToInline({name:"toggle-inline-menu",frameId:t});break;case"Escape":if(!menu.isVisible())return;sendMessageToInline({name:"toggle-inline-menu",frameId:t});break;case"Enter":if(!menu.isVisible()||!menu.isFocused())return void menu.unload();menu.enter()}}else if("op-button-clicked"===e.name)menu.isVisible()?(menu.unload(),setAllState({autoshow:!1})):knight.state.locked?sendMessageToInline({name:"knight-menu-load-locked",frameId:e.data.frameId}):sendMessageToInline({name:"knight-menu-load",frameId:e.data.frameId});else if("knight-menu-load"===e.name){const e=knight.activeInput;if(!e)return;if(menu.frameCreationInProgress)return;setAllState({autoshow:!0}),knight.loadMenu(e,knight.getActiveFillMode(e))}else if("knight-menu-load-locked"===e.name){const e=knight.activeInput;if(!e)return;menu.load(e,`/${knight.state.locale}/locked/${knight.state.tabId}`,"locked")}else if("toggle-inline-menu"===e.name)formManager.click();else if("knight-state"===e.name)knight.setState(e.data.state);else if("inline-position"===e.name){setInlinePosition(e.data.position,e.data.depth)}else"remove-resize-event"===e.name?window.removeEventListener("resize",handleResize):n(!0)}function listen(){chrome.runtime.onMessage.addListener(runtimeMessageHander),chrome.runtime.sendMessage({name:"knight-ready"})}function sendMessageToInline(e,t){return chrome.runtime.sendMessage({name:"send-message-to-inline",data:{message:e}},t),!!t}listen();